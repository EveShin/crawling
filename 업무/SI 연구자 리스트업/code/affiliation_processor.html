<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로컬 파일 소속 정보 처리기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #333; margin-bottom: 10px; font-size: 2.2em; }
        .header p { color: #666; font-size: 1.1em; }
        
        .upload-area { border: 3px dashed #007bff; border-radius: 12px; padding: 60px 20px; text-align: center; margin: 30px 0; background: #f8f9fa; transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { border-color: #0056b3; background: #e7f3ff; }
        .upload-area.dragover { border-color: #28a745; background: #d4edda; }
        .upload-icon { font-size: 4em; color: #007bff; margin-bottom: 20px; }
        .upload-text { font-size: 1.2em; color: #333; margin-bottom: 10px; font-weight: bold; }
        .upload-hint { color: #666; font-size: 0.9em; }
        
        .file-input { display: none; }
        .btn { padding: 15px 30px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #0056b3; transform: translateY(-2px); }
        .btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #333; }
        
        .status { padding: 20px; margin: 20px 0; border-radius: 10px; font-weight: bold; border-left: 5px solid; }
        .status.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .status.info { background: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
        .status.warning { background: #fff3cd; color: #856404; border-color: #ffc107; }
        .status.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        
        .progress-container { margin: 30px 0; }
        .progress-bar { background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-fill { background: linear-gradient(90deg, #28a745, #20c997, #17a2b8); height: 100%; width: 0%; transition: width 0.4s ease; position: relative; }
        .progress-text { text-align: center; margin: 15px 0; font-weight: bold; font-size: 1.1em; }
        
        .file-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #dee2e6; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 30px 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-size: 13px; }
        th { background: linear-gradient(135deg, #f8f9fa, #e9ecef); font-weight: bold; color: #495057; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #e3f2fd; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-card { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #dee2e6; }
        .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
        .stat-label { color: #666; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>대용량 소속 정보 처리기</h1>
            <p>CSV/Excel 파일을 업로드하여 소속 정보를 자동으로 분석하고 구조화합니다</p>
        </div>
        
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">FILE</div>
            <div class="upload-text">파일을 선택하거나 여기에 드래그하세요</div>
            <div class="upload-hint">지원 형식: CSV, XLSX, XLS (최대 크기 제한 없음)</div>
            <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls" multiple>
        </div>
        
        <div id="fileInfo" class="file-info" style="display: none;">
            <h3>파일 정보</h3>
            <div id="fileDetails"></div>
        </div>
        
        <div id="statusBox" class="status info" style="display: none;">
            <span id="statusText">준비 중...</span>
        </div>
        
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div class="progress-text">진행률: <span id="progressPercent">0%</span></div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="controls">
            <button id="processBtn" class="btn" onclick="processFiles()" disabled>데이터 처리 시작</button>
            <button id="excelBtn" class="btn success" onclick="downloadExcel()" disabled>Excel 다운로드</button>
            <button id="csvBtn" class="btn warning" onclick="downloadCSV()" disabled>CSV 다운로드</button>
            <button id="previewBtn" class="btn" onclick="togglePreview()" disabled>미리보기</button>
        </div>
        
        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">총 데이터</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="multiCount">0</div>
                <div class="stat-label">다중 소속</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="singleCount">0</div>
                <div class="stat-label">단일 소속</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="processTime">0</div>
                <div class="stat-label">처리 시간 (초)</div>
            </div>
        </div>
        
        <div id="preview" style="display: none;">
            <h3>처리 결과 미리보기 (상위 20개)</h3>
            <div id="previewContent"></div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let processedData = [];
        let startTime = 0;

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            uploadedFiles = Array.from(files);
            
            if (uploadedFiles.length === 0) return;

            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            let html = '';
            let totalSize = 0;
            
            uploadedFiles.forEach((file, index) => {
                totalSize += file.size;
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border: 1px solid #dee2e6;">
                        <strong>파일 ${index + 1}:</strong> ${file.name}<br>
                        <small>크기: ${sizeMB} MB | 형식: ${file.type || '알 수 없음'} | 수정일: ${new Date(file.lastModified).toLocaleString()}</small>
                    </div>
                `;
            });
            
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            html += `<div style="margin-top: 15px; font-weight: bold; color: #007bff;">총 ${uploadedFiles.length}개 파일, 전체 크기: ${totalSizeMB} MB</div>`;
            
            fileDetails.innerHTML = html;
            fileInfo.style.display = 'block';
            
            document.getElementById('processBtn').disabled = false;
            updateStatus('파일 업로드 완료! 처리를 시작하세요.', 'success');
        }

        function updateStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            const statusText = document.getElementById('statusText');
            
            statusBox.className = 'status ' + type;
            statusText.textContent = message;
            statusBox.style.display = 'block';
        }

        function updateProgress(percent) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
        }

        function parseAffiliation(originalAffiliation) {
            if (!originalAffiliation || originalAffiliation.trim() === '') {
                return { dept: '', org: '' };
            }
            
            const depts = [];
            const orgs = [];
            
            const affiliationParts = originalAffiliation.split('|').map(part => part.trim());
            
            affiliationParts.forEach((part, index) => {
                let cleaned = part;
                
                const originalCleaned = cleaned;
                cleaned = cleaned.replace(/^\[.*?\]\s*/g, '');
                
                if (cleaned === originalCleaned) {
                    cleaned = cleaned.replace(/\[.*?\]\s*/g, '');
                }
                
                if (cleaned === originalCleaned) {
                    cleaned = cleaned.replace(/\[[\s\S]*?\]\s*/g, '');
                }
                
                if (cleaned === originalCleaned) {
                    const patterns = [
                        /^\[첨자없음\]\s*/,
                        /^\[Г·АЪѕшАЅ\]\s*/,
                        /^\[[a-z]\]\s*/i,
                        /^\[.*\]\s*/
                    ];
                    
                    for (const pattern of patterns) {
                        if (pattern.test(cleaned)) {
                            cleaned = cleaned.replace(pattern, '');
                            break;
                        }
                    }
                }
                
                cleaned = cleaned.trim();
                
                if (cleaned) {
                    const segments = cleaned.split(',').map(s => s.trim());
                    
                    if (segments.length >= 2) {
                        const dept = segments[0];
                        const org = segments[1];
                        
                        depts.push(dept);
                        orgs.push(org);
                    } else {
                        depts.push('');
                        orgs.push(cleaned);
                    }
                }
            });
            
            const result = {
                dept: depts.filter(d => d !== '').join(' | '),
                org: orgs.filter(o => o !== '').join(' | ')
            };
            
            return result;
        }

        async function processFiles() {
            if (uploadedFiles.length === 0) {
                updateStatus('처리할 파일이 없습니다.', 'warning');
                return;
            }

            startTime = Date.now();
            processedData = [];
            
            document.getElementById('processBtn').disabled = true;
            updateStatus('파일 읽기 중...', 'info');
            updateProgress(0);

            try {
                let totalRows = 0;
                let processedRows = 0;

                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    updateStatus(`파일 ${i + 1}/${uploadedFiles.length} 처리 중: ${file.name}`, 'info');
                    
                    const data = await readFile(file);
                    
                    if (data && data.length > 0) {
                        totalRows += data.length;
                        
                        for (let j = 0; j < data.length; j++) {
                            const row = data[j];
                            
                            const nameCol = findColumn(row, ['이름', 'name', '성명', 'АМё§']);
                            const originalCol = findColumn(row, ['소속(원본)', '소속', 'јТјУ']);
                            const deptCol = findColumn(row, ['소속(전공/부서)', 'department', 'dept']);
                            const orgCol = findColumn(row, ['소속(대학/기관)', 'organization', 'org', 'university']);
                            
                            if (nameCol && originalCol) {
                                const name = String(row[nameCol] || '').trim();
                                const originalAffiliation = String(row[originalCol] || '').trim();
                                
                                if (name === '' && originalAffiliation === '') {
                                    processedData.push({
                                        name: '',
                                        originalAffiliation: '',
                                        department: '',
                                        organization: ''
                                    });
                                } else if (name && originalAffiliation) {
                                    const parsed = parseAffiliation(originalAffiliation);
                                    
                                    const processedRow = {
                                        name: name,
                                        originalAffiliation: originalAffiliation,
                                        department: parsed.dept,
                                        organization: parsed.org
                                    };
                                    
                                    processedData.push(processedRow);
                                } else {
                                    processedData.push({
                                        name: name,
                                        originalAffiliation: originalAffiliation,
                                        department: '',
                                        organization: ''
                                    });
                                }
                            } else {
                                processedData.push({
                                    name: '',
                                    originalAffiliation: '',
                                    department: '',
                                    organization: ''
                                });
                            }
                            
                            processedRows++;
                            
                            const fileProgress = ((i + (j + 1) / data.length) / uploadedFiles.length) * 80;
                            updateProgress(Math.floor(fileProgress));
                        }
                    }
                }

                updateProgress(90);
                updateStatus('데이터 정제 및 검증 중...', 'info');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(100);
                const processTime = ((Date.now() - startTime) / 1000).toFixed(1);
                updateStatus(`처리 완료! ${processedData.length}개 데이터를 ${processTime}초만에 처리했습니다.`, 'success');
                
                document.getElementById('excelBtn').disabled = false;
                document.getElementById('csvBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;
                document.getElementById('processBtn').disabled = false;
                document.getElementById('processBtn').textContent = '다시 처리';
                
                showStats(processTime);

            } catch (error) {
                updateStatus(`처리 중 오류 발생: ${error.message}`, 'error');
                console.error('Processing error:', error);
            }
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv')) {
                    Papa.parse(file, {
                        header: true,
                        encoding: 'UTF-8',
                        skipEmptyLines: true,
                        transformHeader: function(header) {
                            return header.trim().replace(/[""]/g, '"');
                        },
                        complete: (results) => {
                            resolve(results.data);
                        },
                        error: (error) => {
                            Papa.parse(file, {
                                header: true,
                                encoding: 'EUC-KR',
                                skipEmptyLines: true,
                                complete: (results) => {
                                    resolve(results.data);
                                },
                                error: (error) => {
                                    reject(error);
                                }
                            });
                        }
                    });
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData.length > 0) {
                                const headers = jsonData[0];
                                const rows = jsonData.slice(1).map(row => {
                                    const obj = {};
                                    headers.forEach((header, index) => {
                                        obj[header] = row[index] || '';
                                    });
                                    return obj;
                                });
                                resolve(rows);
                            } else {
                                resolve([]);
                            }
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    reject(new Error('지원하지 않는 파일 형식입니다.'));
                }
            });
        }

        function findColumn(row, possibleNames) {
            const columns = Object.keys(row);
            
            for (const key of columns) {
                for (const name of possibleNames) {
                    if (key === name || key.toLowerCase() === name.toLowerCase()) {
                        return key;
                    }
                }
            }
            
            for (const key of columns) {
                for (const name of possibleNames) {
                    if (key.toLowerCase().includes(name.toLowerCase()) || 
                        key.includes(name)) {
                        return key;
                    }
                }
            }
            
            if (possibleNames.includes('이름') || possibleNames.includes('АМё§')) {
                return columns[0];
            }
            
            if (possibleNames.includes('소속(원본)') || possibleNames.includes('јТјУ')) {
                return columns[1];
            }
            
            if (possibleNames.includes('소속(전공/부서)')) {
                return columns[2];
            }
            
            if (possibleNames.includes('소속(대학/기관)')) {
                return columns[3];
            }
            
            return null;
        }

        function showStats(processTime) {
            const multiAffil = processedData.filter(item => 
                item.department.includes('|') || item.organization.includes('|')
            ).length;
            
            const emptyRows = processedData.filter(item =>
                item.name === '' && item.originalAffiliation === ''
            ).length;
            
            const dataRows = processedData.length - emptyRows;
            
            document.getElementById('totalCount').textContent = processedData.length;
            document.getElementById('multiCount').textContent = multiAffil;
            document.getElementById('singleCount').textContent = dataRows - multiAffil;
            document.getElementById('processTime').textContent = processTime;
            
            document.querySelector('#totalCount').parentNode.querySelector('.stat-label').textContent = 
                `총 행수 (빈 행: ${emptyRows})`;
            
            document.getElementById('stats').style.display = 'grid';
        }

        function togglePreview() {
            const preview = document.getElementById('preview');
            
            if (preview.style.display === 'none') {
                const content = document.getElementById('previewContent');
                let html = '<table><tr><th>이름</th><th>소속(원본)</th><th>소속(전공/부서)</th><th>소속(대학/기관)</th></tr>';
                
                processedData.slice(0, 20).forEach((item, index) => {
                    if (item.name === '' && item.originalAffiliation === '') {
                        html += `<tr style="background-color: #f8f9fa;">
                            <td colspan="4" style="text-align: center; color: #6c757d; font-style: italic;">[빈 행 - 구분용]</td>
                        </tr>`;
                    } else {
                        html += `<tr>
                            <td>${item.name}</td>
                            <td style="max-width: 300px; word-break: break-word; font-size: 11px;">${item.originalAffiliation}</td>
                            <td style="font-size: 12px;">${item.department}</td>
                            <td style="font-size: 12px;">${item.organization}</td>
                        </tr>`;
                    }
                });
                
                html += '</table>';
                content.innerHTML = html;
                preview.style.display = 'block';
                document.getElementById('previewBtn').textContent = '미리보기 닫기';
            } else {
                preview.style.display = 'none';
                document.getElementById('previewBtn').textContent = '미리보기';
            }
        }

        function downloadExcel() {
            try {
                const ws = XLSX.utils.json_to_sheet(processedData.map(item => ({
                    '이름': item.name,
                    '소속(원본)': item.originalAffiliation,
                    '소속(전공/부서)': item.department,
                    '소속(대학/기관)': item.organization
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "처리된_소속정보");
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                XLSX.writeFile(wb, `소속정보_처리결과_${timestamp}.xlsx`);
                
                updateStatus('Excel 파일이 성공적으로 다운로드되었습니다!', 'success');
                
            } catch (error) {
                updateStatus('Excel 파일 생성 중 오류가 발생했습니다.', 'error');
            }
        }

        function downloadCSV() {
            try {
                let csvContent = "이름,소속(원본),소속(전공/부서),소속(대학/기관)\n";
                
                processedData.forEach(item => {
                    const escape = (str) => '"' + str.replace(/"/g, '""') + '"';
                    csvContent += `${escape(item.name)},${escape(item.originalAffiliation)},${escape(item.department)},${escape(item.organization)}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.href = url;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                link.download = `소속정보_처리결과_${timestamp}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                updateStatus('CSV 파일이 성공적으로 다운로드되었습니다!', 'success');
                
            } catch (error) {
                updateStatus('CSV 파일 생성 중 오류가 발생했습니다.', 'error');
            }
        }

        window.onload = function() {
            setupFileUpload();
            updateStatus('파일을 업로드하여 시작하세요. 드래그 앤 드롭 또는 클릭하여 파일을 선택할 수 있습니다.', 'info');
        };
    </script>
</body>
</html>